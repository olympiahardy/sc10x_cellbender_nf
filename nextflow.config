params {
    input_glob = null
    outdir     = null
}

process {
    executor      = 'local'
    maxRetries    = 1
    errorStrategy = 'terminate'

    withName: 'CELLBENDER_REMOVE_BACKGROUND' {

        // IMPORTANT: prevent multiple CellBender runs competing for the same GPU
        maxForks = 1

        // Helps reduce CUDA memory fragmentation (doesn't fix a totally full GPU, but helps a lot)
        env.PYTORCH_CUDA_ALLOC_CONF = 'expandable_segments:True'

        publishDir = [
            path: "${params.outdir}",
            mode: 'move',
            overwrite: true,
            saveAs: { f ->
                def fname = f.toString().tokenize('/').last()

                // Reports -> results/<sample_id>/cellbender_reports/
                if (fname.endsWith('_cellbender_output_report.html')) {
                    return "${sample_id}/cellbender_reports/${fname}"
                }

                // H5 files -> results/<sample_id>/h5_files/
                if (fname.endsWith('.h5')) {
                    return "${sample_id}/h5_files/${fname}"
                }

                // Ignore everything else
                return null
            }
        ]
    }
}

profiles {
    cpu {
        process.executor = 'local'
    }

    gpu {
        process.executor = 'local'

        withName: 'CELLBENDER_REMOVE_BACKGROUND' {
            // DO NOT set CUDA_VISIBLE_DEVICES here.
            // Slurm will set it for the allocated GPU; hardcoding '0' can point to a busy GPU.
            // env.CUDA_VISIBLE_DEVICES = '0'
        }
    }
}
