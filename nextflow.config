params {
    input_glob = null
    outdir     = null
}

process {
    executor      = 'local'
    maxRetries    = 1
    errorStrategy = 'terminate'

    withName: 'CELLBENDER_REMOVE_BACKGROUND' {
        publishDir = [
            path: "${params.outdir}",
            mode: 'move',
            overwrite: true,
            saveAs: { f ->
                def fname = f.toString().tokenize('/').last()

                if (fname.endsWith('_cellbender_output_report.html')) {
                    return "${sample_id}/cellbender_reports/${fname}"
                }
                if (fname.endsWith('.h5')) {
                    return "h5_files/${fname}"
                }
                return null
            }
        ]
    }
}

profiles {
    cpu {
        process.executor = 'local'
    }

    gpu {
        process.executor = 'local'
        withName: 'CELLBENDER_REMOVE_BACKGROUND' {
            env.CUDA_VISIBLE_DEVICES = '0'
        }
    }
}